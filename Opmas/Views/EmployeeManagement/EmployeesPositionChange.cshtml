@using Opmas.Data.DataContext.DataContext.EmployeeDataContext
@using Opmas.Data.Factory.EmployeeManagement
@using Opmas.Data.Service.Enums
@using PositionChange = Opmas.Data.Objects.Entities.Employee.PositionChange
@model IEnumerable<Opmas.Data.Objects.Entities.Employee.Employee>

@{
    ViewBag.Title = "Employees";
    ViewBag.Header = "List Of Employees";
    Layout = "~/Views/Shared/_LayoutListItems.cshtml";
    var employeeData = new EmployeeDataContext();
    var positionChange = new PositionChange();
}
@if (TempData["employee"] != null)
{
    if (TempData["notificationtype"].Equals(NotificationTypeEnum.Success.ToString()))
    {
        <div class="alert alert-success alert-dismissable">@TempData["employee"]</div>
    }
    else if (TempData["notificationtype"].Equals(NotificationTypeEnum.Error.ToString()))
    {
        <div class="alert alert-danger alert-dismissable">@TempData["employee"]</div>
    }
    else if (TempData["notificationtype"].Equals(NotificationTypeEnum.Info.ToString()))
    {
        <div class="alert alert-info alert-dismissable">@TempData["employee"]</div>
    }
}
<table id="datatable" class="table table-striped table-bordered">
    <thead>
    <tr>
        <th>
            @Html.DisplayName("Firstname")
        </th>
        <th>
            @Html.DisplayName("Lastname")
        </th>
        <th>
            @Html.DisplayName("Email")
        </th>
        <th>
            @Html.DisplayName("Previous Position")
        </th>
        <th>
            @Html.DisplayName("Current Position")
        </th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var item in Model)
    {
        long id = item.EmployeeId;
        var workData = employeeData.EmployeeWorkDatas.SingleOrDefault(n => n.EmployeeId == item.EmployeeId);
        var positionChanged = employeeData.PositionChanges.Where(n => n.EmployeeId == item.EmployeeId);
        <tr>
            <td>
                @(new EmployeeFactory().GetEmployeePersonalData(item.EmployeeId).Firstname)
            </td>
            <td>
                @(new EmployeeFactory().GetEmployeePersonalData(item.EmployeeId).Lastname)
            </td>
            <td>
                @(new EmployeeFactory().GetEmployeePersonalData(item.EmployeeId).Email)
            </td>
            @if (workData != null)
            {
             
                <td>
                    @employeeData.EmploymentPositions.Find(workData.EmploymentPositionId).Name
                </td>

            }
            @if (workData != null)
            {

                <td>

                    @{
                        var firstOrDefault = positionChanged.FirstOrDefault();
                    }
                    @if (firstOrDefault != null)
                    {
                        @employeeData.EmploymentPositions.Find(firstOrDefault.EmploymentPositionId).Name
                    }
                </td>

            }

            <td>

                <!-- Button trigger modal -->
                <button type="button" class="btn btn-success btn-xs fa fa-arrow-circle-up" data-toggle="modal" data-target="#myModal1">
                    Promote Employee
                </button>

                <!-- Modal -->
                <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <h4 class="modal-title" id="myModalLabel">Promote Employee</h4>
                            </div>
                            <div class="modal-body">
                                @{
                                    positionChange.EmployeeId = id;
                                    
                                    ViewBag.action = Opmas.Data.Service.Enums.PositionChange.Promotion.ToString();
                                    Html.RenderPartial("PosititonChange", positionChange);
                                }
                            </div>
                        </div>
                    </div>

                </div>
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-danger btn-xs fa fa-arrow-circle-down" data-toggle="modal" data-target="#myModal2">
                    Demote Employee
                </button>

                <!-- Modal -->
                <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <h4 class="modal-title" id="myModalLabel">Demote Employee</h4>
                            </div>
                            <div class="modal-body">
                                @{
                                    positionChange.EmployeeId = id;
                                    ViewBag.action = Opmas.Data.Service.Enums.PositionChange.Demotion.ToString();
                                    Html.RenderPartial("PosititonChange", positionChange);
                                }
                            </div>
                        </div>
                    </div>

                </div>
            </td>
        </tr>
    }
    </tbody>

</table>